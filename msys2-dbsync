#!/bin/bash

set -e

if test -z "${1}"
then
    echo "Missing SF.net username." >&2
    exit 1
fi

if [[ "$(hostname)" == "msys2" ]] && [[ -z "${SSH_AUTH_SOCK}" ]]
then
    echo "This needs SSH agent forwarding enabled..." >&2
    echo "https://docs.github.com/en/developers/overview/using-ssh-agent-forwarding" >&2
    exit 1
fi

pub=/srv/msys2repo
sf="${1}@frs.sourceforge.net:/home/frs/project/msys2"

echo "distrib"
rsync -rtiL --delete $pub/distrib/ $sf/Base/

echo "mingw packages"
rsync -rtiL --exclude "sources" --exclude 'i686' --exclude 'x86_64' --exclude '*.db*' --exclude '*.files*' $pub/mingw/ $sf/REPOS/MINGW/

echo "msys packages"
rsync -rtiL --exclude "sources" --exclude 'i686' --exclude 'x86_64' --exclude '*.db*' --exclude '*.files*' $pub/msys/ $sf/REPOS/MSYS2/

echo "Waiting 30 minutes before syncing databases"
sleep 30m

echo "mingw databases"
rsync -rtiL --exclude "sources" --exclude 'i686' --exclude 'x86_64' --delete $pub/mingw/ $sf/REPOS/MINGW/

echo "msys databases"
rsync -rtiL --exclude "sources" --exclude 'i686' --exclude 'x86_64' --delete $pub/msys/ $sf/REPOS/MSYS2/
